<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Meegov</title>

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous" />

    <!-- Theme CSS -->
    <link href="css/freelancer.min.css" rel="stylesheet">

    <!-- Custom Fonts -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous" />
    <link href="https://fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet" type="text/css">
    <link href="https://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic" rel="stylesheet" type="text/css">

    <!-- jQuery -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js" integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin="anonymous"></script>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

	<style>.rotate{display:inline-block;-webkit-animation-name:rotate;-webkit-animation-duration:2s;-webkit-animation-iteration-count:infinite;-webkit-animation-timing-function:linear;-moz-animation-name:rotate;-moz-animation-duration:2s;-moz-animation-iteration-count:infinite;-moz-animation-timing-function:linear;-o-animation-name:rotate;-o-animation-duration:2s;-o-animation-iteration-count:infinite;-o-animation-timing-function:linear;animation-name:rotate;animation-duration:2s;animation-iteration-count:infinite;animation-timing-function:linear}@-webkit-keyframes rotate{from{-webkit-transform:rotate(0)}to{-webkit-transform:rotate(360deg)}}@-moz-keyframes rotate{from{-moz-transform:rotate(0)}to{-moz-transform:rotate(360deg)}}@-o-keyframes rotate{from{-moz-transform:rotate(0)}to{-moz-transform:rotate(360deg)}}@keyframes rotate{from{transform:rotate(0)}to{transform:rotate(360deg)}}.square{width:50vw;height:50vw}</style>
</head>

<body id="page-top" class="index">

    <!-- Navigation -->
    <nav id="mainNav" class="navbar navbar-default navbar-fixed-top navbar-custom">
        <div class="container">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header page-scroll">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                    <span class="sr-only">Toggle navigation</span> Menu <i class="fa fa-bars"></i>
                </button>
                <a class="navbar-brand" href="#page-top">Meegov</a>
            </div>

            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav navbar-right">
                    <li class="hidden">
                        <a href="#page-top"></a>
                    </li>
                </ul>
            </div>
            <!-- /.navbar-collapse -->
        </div>
        <!-- /.container-fluid -->
    </nav>

    <!-- Header -->
    <header>
        <div class="container">
            <div class="row">
                <div class="col-lg-12">
                    <img class="img-responsive" id="commons-loader" src="img/hoc.png" alt="">
                    <div class="intro-text">
                        <span class="name">What's your government doing for <strong>you</strong>?</span>
                        <hr class="star-light">

                        <fb:login-button scope="public_profile,user_location,user_religion_politics" onlogin="checkLoginState();" size="xlarge" auto-logout-link="true">
                        </fb:login-button>

                        <h4 id="status">
                        </h4>

                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Footer -->
    <footer class="text-center" id="userdata-exp">
        <div class="footer-above">
            <div class="container">
                <div class="row">
                    <div class="footer-col col-md-4" id="localData">
                        <h3>Local</h3>
						<h4>Based on your age, we think your priorities are</h4>
						<h5 id="agePriority1"></h5>
						<p>Your local council spent <strong id="apDataNugget1"></strong> of it's budget last year on <span id="agePriority1nc"></span>.</p>
						<h4>Based on post analysis, we think your priorities are</h4>
						<h5 id="postPriority1"></h5>
						<p>Your local council spent <strong id="ppDataNugget1"></strong> of it's budget last year on <span id="postPriority1nc"></span>.</p>
                    </div>
                    <div class="footer-col col-md-4" id="nationalData">
                        <h3>National</h3>
						<h4>Based on your political affiliation, we thought you'd be interested in this</h4>
						<h5 id="partyName"></h5><span class="partyColour" id="partyCBox"></span>
						House of Commons: <i class="fa" aria-hidden="true" id="partyHoC"></i>
						House of Lords: <i class="fa" aria-hidden="true" id="partyHoL"></i>
                    </div>
                    <div class="footer-col col-md-4">
                        <h3>Actions</h3>
                        <p>Don't like something on here? Write to your representatives.</p>
                        <div>
                            <form style="text-align:center" action="https://www.writetothem.com/" target="_blank" method="get">
                                <div>
                                    <div style="margin-bottom:0.25em;">
                                        <h3>Enter your postcode.</h3>
                                    </div>
                                    <div class="input-group">
                                        <input name="pc" class="form-control" type="text" size="13">
                                        <span class="input-group-btn">
										   <input class="btn btn-success" type="submit" value="Go">
								</span>
                                    </div>
                                </div>
                            </form>
                            <small>Powered by <a href="https://writetothem.com/">WriteToThem</a></small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="footer-below">
            <div class="container">
                <div class="row">
                    <div class="col-lg-12">
                        This data comes from <del>the National Audit Office under the Open Government License</del> nowhere, as the data doesn't exist. Boo. Give us data!
                    </div>
                </div>
            </div>
        </div>
    </footer>

    <!-- Scroll to Top Button (Only visible on small and extra-small screen sizes) -->
    <div class="scroll-top page-scroll hidden-sm hidden-xs hidden-lg hidden-md">
        <a class="btn btn-primary" href="#page-top">
            <i class="fa fa-chevron-up"></i>
        </a>
    </div>

    <!-- Bootstrap Core JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script>

    <!-- Plugin JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-easing/1.3/jquery.easing.min.js"></script>

    <!-- Theme JavaScript -->
    <script src="js/freelancer.min.js"></script>

    <script>
		
		String.prototype.fuzzy = function(term, ratio) {
			var string = this.toLowerCase();
			var compare = term.toLowerCase();
			var matches = 0;
			if (string.indexOf(compare) > -1) return true; // covers basic partial matches
			for (var i = 0; i < compare.length; i++) {
				string.indexOf(compare[i]) > -1 ? matches += 1 : matches -=1;
			}
			return (matches/this.length >= ratio || term == "")
		};
		
		var politics;
        var cstatus = $('#status');
        var userexp = $("#userdata-exp");
		var cload = $("#commons-loader");
        cstatus.hide();
        userexp.hide();
        // This is called with the results from from FB.getLoginStatus().
        function statusChangeCallback(response,isActive) {
            console.log('statusChangeCallback');
            console.log(response);
            // The response object is returned with a status field that lets the
            // app know the current login status of the person.
            // Full docs on the response object can be found in the documentation
            // for FB.getLoginStatus().
            if (response.status === 'connected' && isActive === true) {
                // Logged into your app and Facebook.
                startAnalysis();
            } else if (response.status === 'not_authorized') {
                // The person is logged into Facebook, but not your app.
                document.getElementById('status').innerHTML = 'Please log ' +
                    'into this app.';
            } else if (isActive === false) {
				FB.logout(function(response) {});
			} else {
                // The person is not logged into Facebook, so we're not sure if
                // they are logged into this app or not.
                document.getElementById('status').innerHTML = 'Please log ' +
                    'into Facebook.';
            }
        }

        // This function is called when someone finishes with the Login
        // Button.  See the onlogin handler attached to it in the sample
        // code below.
        function checkLoginState() {
            FB.getLoginStatus(function(response) {
                statusChangeCallback(response,true);
            });
        }

        window.fbAsyncInit = function() {
            FB.init({
                appId: '1165068333580206',
                cookie: true, // enable cookies to allow the server to access 
                // the session
                xfbml: true, // parse social plugins on this page
                version: 'v2.8' // use graph api version 2.8
            });

            // Now that we've initialized the JavaScript SDK, we call 
            // FB.getLoginStatus().  This function gets the state of the
            // person visiting this page and can return one of three states to
            // the callback you provide.  They can be:
            //
            // 1. Logged into your app ('connected')
            // 2. Logged into Facebook, but not your app ('not_authorized')
            // 3. Not logged into Facebook and can't tell if they are logged into
            //    your app or not.
            //
            // These three cases are handled in the callback function.

            FB.getLoginStatus(function(response) {
              statusChangeCallback(response,false);
            });

        };

        // Load the SDK asynchronously
        (function(d, s, id) {
            var js, fjs = d.getElementsByTagName(s)[0];
            if (d.getElementById(id)) return;
            js = d.createElement(s);
            js.id = id;
            js.src = "//connect.facebook.net/en_US/sdk.js";
            fjs.parentNode.insertBefore(js, fjs);
        }(document, 'script', 'facebook-jssdk'));

        // Here we run a very simple test of the Graph API after login is
        // successful.  See statusChangeCallback() for when this call is made.
        function startAnalysis() {			
            console.log('Logged in');
			cload.addClass("rotate");
            FB.api('/me?fields=location,name', function(response) {
                console.log('Successful login for: ' + response.name);
				$(".name").fadeOut();
                cstatus.fadeIn();
                cstatus.html('Hi ' + response.name + '! Please wait, we\'re getting some insights...');
				getPoliticalParty().done(function(party) {
					politics = party;
					politicalPartyAnalysis(politics).done(function(result) {
						$("#partyName").html(result[0]);
						function HoCset(isHOC) {
							var HOCval = $("#partyHoC");
							if (isHOC) {
								HOCval.addClass("fa-check");
							} else {
								HOCval.addClass("fa-times");
							}
						}
						function HoLset(isHOL) {
							var HOLval = $("#partyHoL");
							if (isHOL) {
								HOLval.addClass("fa-check");
							} else {
								HOLval.addClass("fa-times");
							}
						}
						if (result[1] == "False" && result[2] == "False") {
							HoCset(false);
							HoLset(false);
						} else if (result[1] == "True" && result[2] == "True") {
							HoCset(true);
							HoLset(true);
						} else if (result[1] == "False" && result[2] == "True") {
							HoCset(false);
							HoLset(true);
						} else {
							HoCset(true);
							HoLset(false);
						}
						
						$("#partyCBox").style.backgroundColor = result[3];
					});
				});
                setTimeout(function() {
                    cstatus.fadeOut();
                    cstatus.html('You live in ' + response.location.name + '. Hmm, interesting!');
                    cstatus.fadeIn();
                    setTimeout(function() {
                        cstatus.fadeOut();
                        cstatus.html('We think you support the ' + politics + '. Looks good!');
                        cstatus.fadeIn();
                        setTimeout(function() {
							cstatus.html("Enjoy!");
							determineAgeBasedInterests();
                            userexp.fadeIn();
							cload.removeClass("rotate");
							$('html, body').animate({
								scrollTop: userexp.offset().top
							}, 1000);
                        }, 4000);
                    }, 4000);
                }, 4000);
            });
        }

        function determineAgeBasedInterests() {
			var agePriority1 = $("#agePriority1");
			var agePriority1DN = $("#apDataNugget1");
			var agePriority1NC = $("#agePriority1nc");
            FB.api('/me?fields=age_range', function(response) {
				var minage = response.age_range.min;
                if (minage < 25) {
					agePriority1.html("Education");
					agePriority1NC.html("education");
                } else if (minage < 55) {
                    agePriority1.html("Job creation");					
					agePriority1NC.html("job creation");
                } else {
                    agePriority1.html("Pensions");					
					agePriority1NC.html("pensions");
                }
				agePriority1DN.html("110%");
            });
        }

        function getPoliticalParty() {
			var dfd = $.Deferred();
            FB.api('/me?fields=political', function(response) {
				dfd.resolve( response.political.slice(0, -3));
            });
			return dfd.promise();
        }
		
		function politicalPartyAnalysis(party) {
			var dfd = $.Deferred();
			$.getJSON( "js/members.json", function( data ) {
				$.each(data.Parties.Party, function(i, v) {
					if (v.Name.fuzzy(party,0.2)) {
						dfd.resolve([v.Name,v.IsCommons,v.IsLords,v.Colour]);
					}
				});
			});
			return dfd.promise();
		}
    </script>

</body>

</html>